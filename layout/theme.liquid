<!doctype html>
<html lang="{{ request.locale.iso_code }}">
  <head>
    {% render 'css-variables' %}

    {% # Load and preload the critical CSS %}
    {{ 'output.css' | asset_url | stylesheet_tag: preload: true }}
    {% # Social, title, etc. %}
    {% render 'meta-tags' %}

    {{ content_for_header }}


  </head>

  <body class="color-scheme color-scheme--{{ settings.color_theme_scheme }} flex flex-col min-h-screen">

    {% sections 'header-group' %}

    {{ content_for_layout }}

    {% sections 'footer-group' %}
    
    {% # Side Cart Drawer %}
    {% render 'side-cart' %}

    {% # Block any PC banners from displaying in development mode %}
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.2/dist/cdn.min.js"></script>
    {%- if theme.role == "development" or request.design_mode -%}
      {% style %}
        #shopify-pc__banner {
          display: none !important;
        }
      {% endstyle %}
    {%- endif -%}

    {% # Initialize cart store SYNCHRONOUSLY before Alpine processes DOM %}
    {% # Using inline initialization to avoid module loading delays %}
    <script>
      // Initialize empty cart store immediately during alpine:init
      // This ensures $store.cart always exists, even if data isn't loaded yet
      document.addEventListener('alpine:init', () => {
        if (typeof window.Alpine !== 'undefined') {
          // Register minimal store structure immediately
          window.Alpine.store('cart', {
            items: [],
            item_count: 0,
            total_price: 0,
            formatted_total: '$0.00',
            loading: true, // Start in loading state
            error: null,
            updatingItems: new Set(), // Track which items are being updated by key

            updateCart(cartData) {
              const items = Array.isArray(cartData.items) ? cartData.items : [];
              this.items = items;
              this.item_count = cartData.item_count || 0;
              this.total_price = cartData.total_price || 0;
              this.formatted_total = this.formatMoney(cartData.total_price || 0);
              this.error = null;
              this.loading = false;
            },

            formatMoney(cents) {
              if (typeof window.Shopify !== 'undefined' && window.Shopify.formatMoney) {
                return window.Shopify.formatMoney(cents);
              }
              return `$${(cents / 100).toFixed(2)}`;
            },

            getItem(key) {
              return this.items.find(item => item.key === key) || null;
            },

            setLoading(isLoading) {
              this.loading = isLoading;
            },

            setError(errorMessage) {
              this.error = errorMessage;
            },

            setItemUpdating(key, isUpdating) {
              if (isUpdating) {
                this.updatingItems.add(key);
              } else {
                this.updatingItems.delete(key);
              }
              // Force reactivity by creating a new Set
              this.updatingItems = new Set(this.updatingItems);
            },

            isItemUpdating(key) {
              return this.updatingItems.has(key);
            }
          });
          //console.log('Cart store initialized inline before Alpine processing');
        }
      });
    </script>

    <script type="module" src="{{ 'main.js' | asset_url }}"></script>
  </body>
</html>
