{% comment %}
  Enhanced Variant Selector with Color Swatches and Size Buttons
  --------------------------------------------------------------
  Supports:
  - Color swatches with Shopify metafields (hex, images, or swatch objects)
  - Size buttons for size options
  - Fallback select dropdowns for other options
  - Automatic variant matching and availability updates

  Usage:
  {% render 'variant-selector', product: product, section_id: section.id %}
{% endcomment %}

{% if product.has_only_default_variant == false %}
  <div
    class="variant-selector"
    data-variant-selector="{{ section_id }}"
  >
    {% comment %} Product data for JavaScript {% endcomment %}
    <script type="application/json" data-product-json>
      {
        "id": {{ product.id | json }},
        "title": {{ product.title | json }},
        "handle": {{ product.handle | json }},
        "options": {{ product.options | json }},
        "variants": [
          {% for variant in product.variants %}
            {
              "id": {{ variant.id | json }},
              "title": {{ variant.title | json }},
              "option1": {{ variant.option1 | json }},
              "option2": {{ variant.option2 | json }},
              "option3": {{ variant.option3 | json }},
              "options": {{ variant.options | json }},
              "price": {{ variant.price | json }},
              "compare_at_price": {{ variant.compare_at_price | json }},
              "available": {{ variant.available | json }},
              "featured_image": {% if variant.featured_image %}{{ variant.featured_image | json }}{% else %}null{% endif %}
            }{% unless forloop.last %},{% endunless %}
          {% endfor %}
        ],
        "selected_or_first_available_variant": {
          "id": {{ product.selected_or_first_available_variant.id | json }},
          "title": {{ product.selected_or_first_available_variant.title | json }},
          "options": {{ product.selected_or_first_available_variant.options | json }},
          "price": {{ product.selected_or_first_available_variant.price | json }},
          "compare_at_price": {{ product.selected_or_first_available_variant.compare_at_price | json }},
          "available": {{ product.selected_or_first_available_variant.available | json }}
        }
      }
    </script>

    {% comment %} Render each option {% endcomment %}
    {% for option in product.options_with_values %}
      {% assign option_name = option.name | downcase %}
      {% assign option_index = forloop.index0 %}

      <div class="variant-option-group mb-4">
        <label class="block mb-2 font-medium underline">
          {{ option.name }}
        </label>

        {% comment %} Check if this is a color option {% endcomment %}
        {% if option_name == 'color' or option_name == 'colour' %}
          {% comment %} Color Swatches {% endcomment %}
          <div class="flex flex-wrap gap-2" role="group" aria-label="{{ option.name }} options">
            {% for value in option.values %}
              {% comment %} Find variant with this color to get metafield {% endcomment %}
              {% assign color_variant = null %}
              {% for variant in product.variants %}
                {% if variant.options[option_index] == value %}
                  {% assign color_variant = variant %}
                  {% break %}
                {% endif %}
              {% endfor %}

              {% comment %} Get color from metafield (supports multiple namespaces) {% endcomment %}
              {% assign color_value = null %}
              {% assign has_swatch = false %}

              {% if color_variant %}
                {% comment %} Try common metafield namespaces {% endcomment %}
                {% if color_variant.metafields.color.value %}
                  {% assign color_value = color_variant.metafields.color.value %}
                {% elsif color_variant.metafields.custom.color %}
                  {% assign color_value = color_variant.metafields.custom.color %}
                {% elsif color_variant.metafields.details.color %}
                  {% assign color_value = color_variant.metafields.details.color %}
                {% endif %}
              {% endif %}

              {% comment %} Check if option value has a swatch {% endcomment %}
              {% assign option_value_handle = value | handle %}
              {% if value.swatch %}
                {% assign has_swatch = true %}
              {% endif %}

              <button
                type="button"
                class="variant-option variant-option--color relative w-12 h-12 border-2 border-gray-300 rounded-full overflow-hidden transition-all hover:scale-110 hover:border-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900"
                data-variant-option="{{ section_id }}"
                data-option-type="color"
                data-option-name="{{ option.name }}"
                data-option-value="{{ value }}"
                aria-label="{{ value }}"
                aria-pressed="{% if option.selected_value == value %}true{% else %}false{% endif %}"
                title="{{ value }}"
              >
                {% comment %} Render color swatch {% endcomment %}
                {% if has_swatch and value.swatch.image %}
                  {% comment %} Image swatch {% endcomment %}
                  <img
                    src="{{ value.swatch.image | image_url: width: 50 }}"
                    alt="{{ value }}"
                    class="w-full h-full object-cover"
                    loading="lazy"
                  >
                {% elsif has_swatch and value.swatch.color %}
                  {% comment %} Shopify swatch object with color {% endcomment %}
                  <span
                    class="block w-full h-full"
                    style="background-color: {{ value.swatch.color }};"
                  ></span>
                {% elsif color_value %}
                  {% comment %} Metafield color value {% endcomment %}
                  <span
                    class="block w-full h-full"
                    style="background-color: {{ color_value }};"
                  ></span>
                {% else %}
                  {% comment %} Fallback: try to map common color names {% endcomment %}
                  {% assign color_map = value | downcase %}
                  {% case color_map %}
                    {% when 'black' %}
                      <span class="block w-full h-full bg-black"></span>
                    {% when 'white' %}
                      <span class="block w-full h-full bg-white border border-gray-300"></span>
                    {% when 'red' %}
                      <span class="block w-full h-full bg-red-600"></span>
                    {% when 'blue' %}
                      <span class="block w-full h-full bg-blue-600"></span>
                    {% when 'green' %}
                      <span class="block w-full h-full bg-green-600"></span>
                    {% when 'yellow' %}
                      <span class="block w-full h-full bg-yellow-400"></span>
                    {% when 'pink' %}
                      <span class="block w-full h-full bg-pink-500"></span>
                    {% when 'purple' %}
                      <span class="block w-full h-full bg-purple-600"></span>
                    {% when 'gray' or 'grey' %}
                      <span class="block w-full h-full bg-gray-500"></span>
                    {% when 'navy' %}
                      <span class="block w-full h-full bg-blue-900"></span>
                    {% when 'brown' %}
                      <span class="block w-full h-full bg-amber-800"></span>
                    {% when 'beige' %}
                      <span class="block w-full h-full bg-amber-100"></span>
                    {% when 'orange' %}
                      <span class="block w-full h-full bg-orange-500"></span>
                    {% else %}
                      {% comment %} Ultimate fallback: show color name as text {% endcomment %}
                      <span class="block w-full h-full flex items-center justify-center text-xs bg-gray-200">
                        {{ value | slice: 0, 2 | upcase }}
                      </span>
                  {% endcase %}
                {% endif %}

                {% comment %} Selected indicator {% endcomment %}
                <span class="absolute inset-0 border-2 border-transparent rounded-full variant-option__selected-ring pointer-events-none"></span>
              </button>
            {% endfor %}
          </div>

        {% elsif option_name == 'size' %}
          {% comment %} Size Buttons {% endcomment %}
          <div class="flex flex-wrap gap-2" role="group" aria-label="{{ option.name }} options">
            {% for value in option.values %}
              <button
                type="button"
                class="variant-option variant-option--size px-4 py-2 border border-gray-300 rounded hover:border-gray-900 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900"
                data-variant-option="{{ section_id }}"
                data-option-type="button"
                data-option-name="{{ option.name }}"
                data-option-value="{{ value }}"
                aria-pressed="{% if option.selected_value == value %}true{% else %}false{% endif %}"
              >
                {{ value }}
              </button>
            {% endfor %}
          </div>

        {% else %}
          {% comment %} Other options: Buttons or Select Dropdown {% endcomment %}
          {% if option.values.size <= 5 %}
            {% comment %} Use buttons for 5 or fewer options {% endcomment %}
            <div class="flex flex-wrap gap-2" role="group" aria-label="{{ option.name }} options">
              {% for value in option.values %}
                <button
                  type="button"
                  class="variant-option variant-option--button px-4 py-2 border border-gray-300 rounded hover:border-gray-900 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900"
                  data-variant-option="{{ section_id }}"
                  data-option-type="button"
                  data-option-name="{{ option.name }}"
                  data-option-value="{{ value }}"
                  aria-pressed="{% if option.selected_value == value %}true{% else %}false{% endif %}"
                >
                  {{ value }}
                </button>
              {% endfor %}
            </div>
          {% else %}
            {% comment %} Use select dropdown for more than 5 options {% endcomment %}
            <select
              class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-gray-900"
              data-variant-option="{{ section_id }}"
              data-option-type="select"
              data-option-name="{{ option.name }}"
            >
              {% for value in option.values %}
                <option
                  value="{{ value }}"
                  {% if option.selected_value == value %}selected{% endif %}
                >
                  {{ value }}
                </option>
              {% endfor %}
            </select>
          {% endif %}
        {% endif %}
      </div>
    {% endfor %}
  </div>
{% endif %}
