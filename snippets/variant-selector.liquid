{% comment %}
  Enhanced Variant Selector with Color Swatches and Size Buttons
  --------------------------------------------------------------
  Supports:
  - Color swatches with Shopify metafields (hex, images, or swatch objects)
  - Size buttons for size options
  - Fallback select dropdowns for other options
  - Automatic variant matching and availability updates

  Usage:
  {% render 'variant-selector', product: product, section_id: section.id %}
{% endcomment %}

{% if product.has_only_default_variant == false %}
  <div
    class="variant-selector"
    data-variant-selector="{{ section_id }}"
  >
    {% comment %} Product data for JavaScript {% endcomment %}
    <script type="application/json" data-product-json>
      {
        "id": {{ product.id | json }},
        "title": {{ product.title | json }},
        "handle": {{ product.handle | json }},
        "options": {{ product.options | json }},
        "variants": [
          {% for variant in product.variants %}
            {
              "id": {{ variant.id | json }},
              "title": {{ variant.title | json }},
              "option1": {{ variant.option1 | json }},
              "option2": {{ variant.option2 | json }},
              "option3": {{ variant.option3 | json }},
              "options": {{ variant.options | json }},
              "price": {{ variant.price | json }},
              "compare_at_price": {{ variant.compare_at_price | json }},
              "available": {{ variant.available | json }},
              "featured_image": {% if variant.featured_image %}{{ variant.featured_image. }}{% else %}null{% endif %}
            }{% unless forloop.last %},{% endunless %}
          {% endfor %}
        ],
        "selected_or_first_available_variant": {
          "id": {{ product.selected_or_first_available_variant.id | json }},
          "title": {{ product.selected_or_first_available_variant.title | json }},
          "options": {{ product.selected_or_first_available_variant.options | json }},
          "price": {{ product.selected_or_first_available_variant.price | json }},
          "compare_at_price": {{ product.selected_or_first_available_variant.compare_at_price | json }},
          "available": {{ product.selected_or_first_available_variant.available | json }}
        }
      }
    </script>

    {% comment %} Render each option {% endcomment %}
    {% for option in product.options_with_values %}
      {% assign option_name = option.name | downcase %}
      {% assign option_index = forloop.index0 %}

      <div class="variant-option-group mt-8">
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-medium text-gray-900">{{ option.name }}</h3>
        </div>

        {% comment %} Check if this is a color option {% endcomment %}
        {% if option_name == 'color' or option_name == 'colour' %}
          {% comment %} Color Swatches {% endcomment %}
          <div class="mt-4">
            <span class="sr-only">Choose a color</span>
            <div class="flex items-center gap-2" role="group" aria-label="{{ option.name }} options">
            {% for value in option.values %}
              {% comment %} Find variant with this color to get metafield {% endcomment %}
              {% assign color_variant = null %}
              {% for variant in product.variants %}
                {% if variant.options[option_index] == value %}
                  {% assign color_variant = variant %}
                  {% break %}
                {% endif %}
              {% endfor %}

              {% comment %} Get color from metafield (supports multiple namespaces) {% endcomment %}
              {% assign color_value = null %}
              {% assign has_swatch = false %}

              {% if color_variant %}
                {% comment %} Try common metafield namespaces {% endcomment %}
                {% if color_variant.metafields.color.value %}
                  {% assign color_value = color_variant.metafields.color.value %}
                {% elsif color_variant.metafields.custom.color %}
                  {% assign color_value = color_variant.metafields.custom.color %}
                {% elsif color_variant.metafields.details.color %}
                  {% assign color_value = color_variant.metafields.details.color %}
                {% endif %}
              {% endif %}

              {% comment %} Check if option value has a swatch {% endcomment %}
              {% assign option_value_handle = value | handle %}
              {% if value.swatch %}
                {% assign has_swatch = true %}
              {% endif %}

              <button
                type="button"
                class="variant-option variant-option--color relative -m-0.5 flex cursor-pointer items-center justify-center rounded-full p-0.5 focus:outline-none ring-gray-400 aria-pressed:ring-2"
                data-variant-option="{{ section_id }}"
                data-option-type="color"
                data-option-name="{{ option.name }}"
                data-option-value="{{ value }}"
                aria-label="{{ value }}"
                aria-pressed="{% if option.selected_value == value %}true{% else %}false{% endif %}"
                title="{{ value }}"
              >
                <span class="sr-only">{{ value }}</span>
                {% comment %} Render color swatch {% endcomment %}
                {% if has_swatch and value.swatch.image %}
                  {% comment %} Image swatch {% endcomment %}
                  <span class="h-8 w-8 rounded-full border border-black border-opacity-10 overflow-hidden">
                    <img
                      src="{{ value.swatch.image | image_url: width: 50 }}"
                      alt="{{ value }}"
                      class="h-full w-full object-cover object-center"
                      loading="lazy"
                    >
                  </span>
                {% elsif has_swatch and value.swatch.color %}
                  {% comment %} Shopify swatch object with color {% endcomment %}
                  <span
                    class="h-8 w-8 rounded-full border border-black border-opacity-10"
                    style="background-color: {{ value.swatch.color }};"
                  ></span>
                {% elsif color_value %}
                  {% comment %} Metafield color value {% endcomment %}
                  <span
                    class="h-8 w-8 rounded-full border border-black border-opacity-10"
                    style="background-color: {{ color_value }};"
                  ></span>
                {% else %}
                  {% comment %} Fallback: try to map common color names {% endcomment %}
                  {% assign color_map = value | downcase %}
                  {% case color_map %}
                    {% when 'black' %}
                      <span class="h-8 w-8 rounded-full border border-black border-opacity-10 bg-gray-900"></span>
                    {% when 'white' %}
                      <span class="h-8 w-8 rounded-full border border-gray-300 bg-white"></span>
                    {% when 'red' %}
                      <span class="h-8 w-8 rounded-full border border-black border-opacity-10 bg-red-600"></span>
                    {% when 'blue' %}
                      <span class="h-8 w-8 rounded-full border border-black border-opacity-10 bg-blue-600"></span>
                    {% when 'green' %}
                      <span class="h-8 w-8 rounded-full border border-black border-opacity-10 bg-green-600"></span>
                    {% when 'yellow' %}
                      <span class="h-8 w-8 rounded-full border border-black border-opacity-10 bg-yellow-400"></span>
                    {% when 'pink' %}
                      <span class="h-8 w-8 rounded-full border border-black border-opacity-10 bg-pink-500"></span>
                    {% when 'purple' %}
                      <span class="h-8 w-8 rounded-full border border-black border-opacity-10 bg-purple-600"></span>
                    {% when 'gray' or 'grey' %}
                      <span class="h-8 w-8 rounded-full border border-black border-opacity-10 bg-gray-500"></span>
                    {% when 'navy' %}
                      <span class="h-8 w-8 rounded-full border border-black border-opacity-10 bg-blue-900"></span>
                    {% when 'brown' %}
                      <span class="h-8 w-8 rounded-full border border-black border-opacity-10 bg-amber-800"></span>
                    {% when 'beige' %}
                      <span class="h-8 w-8 rounded-full border border-black border-opacity-10 bg-amber-100"></span>
                    {% when 'orange' %}
                      <span class="h-8 w-8 rounded-full border border-black border-opacity-10 bg-orange-500"></span>
                    {% else %}
                      {% comment %} Ultimate fallback: show color name as text {% endcomment %}
                      <span class="h-8 w-8 rounded-full border border-black border-opacity-10 bg-gray-200 flex items-center justify-center text-xs font-medium text-gray-700">
                        {{ value | slice: 0, 2 | upcase }}
                      </span>
                  {% endcase %}
                {% endif %}
              </button>
            {% endfor %}
            </div>
          </div>

        {% elsif option_name == 'size' %}
          {% comment %} Size Buttons {% endcomment %}
          <div class="mt-4">
            <span class="sr-only">Choose a size</span>
            <div class="grid grid-cols-4 gap-4 sm:grid-cols-8 lg:grid-cols-4" role="group" aria-label="{{ option.name }} options">
            {% for value in option.values %}
              <button
                type="button"
                class="variant-option variant-option--size group relative flex items-center justify-center rounded-md border py-3 px-4 text-sm font-medium uppercase hover:bg-gray-50 focus:outline-none sm:flex-1 sm:py-6 border-gray-300 bg-white text-gray-900 shadow-sm cursor-pointer aria-pressed:border-transparent aria-pressed:bg-indigo-600 aria-pressed:text-white hover:aria-pressed:bg-indigo-700"
                data-variant-option="{{ section_id }}"
                data-option-type="button"
                data-option-name="{{ option.name }}"
                data-option-value="{{ value }}"
                aria-pressed="{% if option.selected_value == value %}true{% else %}false{% endif %}"
              >
                <span>{{ value }}</span>
                <span class="pointer-events-none absolute -inset-px rounded-md aria-pressed:border-2 aria-pressed:border-indigo-600" aria-hidden="true"></span>
              </button>
            {% endfor %}
            </div>
          </div>

        {% else %}
          {% comment %} Other options: Buttons or Select Dropdown {% endcomment %}
          {% if option.values.size <= 5 %}
            {% comment %} Use buttons for 5 or fewer options {% endcomment %}
            <div class="mt-4">
              <div class="flex flex-wrap gap-3" role="group" aria-label="{{ option.name }} options">
                {% for value in option.values %}
                  <button
                    type="button"
                    class="variant-option variant-option--button px-6 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-900 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 aria-pressed:border-indigo-600 aria-pressed:bg-indigo-50"
                    data-variant-option="{{ section_id }}"
                    data-option-type="button"
                    data-option-name="{{ option.name }}"
                    data-option-value="{{ value }}"
                    aria-pressed="{% if option.selected_value == value %}true{% else %}false{% endif %}"
                  >
                    {{ value }}
                  </button>
                {% endfor %}
              </div>
            </div>
          {% else %}
            {% comment %} Use select dropdown for more than 5 options {% endcomment %}
            <div class="mt-4">
              <select
                class="mt-1 block w-full rounded-md border-gray-300 py-3 pl-3 pr-10 text-base focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm"
                data-variant-option="{{ section_id }}"
                data-option-type="select"
                data-option-name="{{ option.name }}"
              >
                {% for value in option.values %}
                  <option
                    value="{{ value }}"
                    {% if option.selected_value == value %}selected{% endif %}
                  >
                    {{ value }}
                  </option>
                {% endfor %}
              </select>
            </div>
          {% endif %}
        {% endif %}
      </div>
    {% endfor %}
  </div>
{% endif %}
